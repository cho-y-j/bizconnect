# 작업 일지 - 2025년 12월 9일

## 작업 날짜
**2025년 12월 9일 (월요일)**

---

## 주요 성과

### 콜백 SMS 발송 성공!
- Android 15 (Galaxy S22) 호환성 문제 해결
- 통화 종료 후 자동 문자 발송 테스트 성공
- 3가지 콜백 이벤트 타입 구현 완료

---

## 상세 작업 내용

### 1. Android 12+ / Android 13+ 호환성 수정
**파일**: `mobile/node_modules/react-native-get-sms-android/android/src/main/java/com/react/SmsModule.java`

#### 문제
- Android 12+ (API 31+): `PendingIntent.FLAG_IMMUTABLE` 필수
- Android 13+ (API 33+): `registerReceiver`에 `RECEIVER_EXPORTED` 또는 `RECEIVER_NOT_EXPORTED` 플래그 필수

#### 수정 코드
```java
// PendingIntent 플래그 추가 (Android 12+)
int pendingFlags = Build.VERSION.SDK_INT >= Build.VERSION_CODES.S
    ? PendingIntent.FLAG_IMMUTABLE : 0;
PendingIntent sentPI = PendingIntent.getBroadcast(context, 0, new Intent(SENT), pendingFlags);

// registerReceiver 플래그 추가 (Android 13+)
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
    context.registerReceiver(new BroadcastReceiver() {
        // ... 콜백 코드
    }, new IntentFilter(SENT), Context.RECEIVER_NOT_EXPORTED);
} else {
    context.registerReceiver(new BroadcastReceiver() {
        // ... 콜백 코드
    }, new IntentFilter(SENT));
}
```

---

### 2. taskService.ts 구문 오류 수정
**파일**: `mobile/src/services/taskService.ts`

#### 문제
- try 블록에 catch 절이 없는 구문 오류

#### 수정
```typescript
// 수정 전 (라인 139)
this.subscription = channel;
}  // try 블록만 있고 catch 없음

// 수정 후
this.subscription = channel;
} catch (error) {
  console.error('Error in subscribeToTasks:', error);
}
```

---

### 3. babel.config.js 생성
**파일**: `mobile/babel.config.js`

```javascript
module.exports = {
  presets: ['module:@react-native/babel-preset'],
};
```

---

### 4. 3가지 콜백 이벤트 타입 구현
**파일**: `mobile/src/lib/callbackManager.ts`

#### 새로 추가된 타입과 설정
```typescript
// 콜백 이벤트 타입
export type CallEventType = 'ended' | 'missed' | 'busy';

// 기본 메시지
const DEFAULT_MESSAGES = {
  ended: '안녕하세요, 방금 통화 감사합니다. 궁금하신 점 있으시면 편하게 연락주세요.',
  missed: '안녕하세요, 전화를 받지 못해 죄송합니다. 확인 후 다시 연락드리겠습니다.',
  busy: '안녕하세요, 통화중이라 받지 못했습니다. 잠시 후 연락드리겠습니다.',
};

// 콜백 설정 인터페이스
export interface CallbackConfig {
  enabled: boolean;
  autoSend: boolean;
  delay: number;
  // 3가지 옵션별 설정
  onEndEnabled: boolean;
  onEndMessage: string;
  onMissedEnabled: boolean;
  onMissedMessage: string;
  onBusyEnabled: boolean;
  onBusyMessage: string;
  // 명함 이미지
  businessCardEnabled: boolean;
  businessCardImageUrl: string | null;
}
```

#### 새로 추가된 함수
```typescript
/**
 * 통화 이벤트 처리 (3가지 타입: ended, missed, busy)
 */
export async function handleCallEvent(
  userId: string,
  phoneNumber: string,
  eventType: CallEventType
): Promise<void>
```

---

### 5. 통화 감지 서비스 업데이트
**파일**: `mobile/src/services/callDetectionService.ts`

#### 이벤트 타입 결정 로직
```typescript
function determineCallEventType(lastState: string | null, answered: boolean): CallEventType | null {
  if (lastState === 'Offhook' && answered) {
    // 전화를 받고 끊음 = 통화 종료
    return 'ended';
  } else if (lastState === 'Incoming' && !answered) {
    // 전화가 왔는데 안 받고 끊김 = 부재중
    return 'missed';
  } else if (lastState === 'Offhook' && !answered) {
    // 발신 전화 끊음 (콜백 안 보냄)
    return null;
  }
  return 'ended';
}
```

---

### 6. 직접 SMS 발송 함수 추가
**파일**: `mobile/src/lib/smsSender.ts`

```typescript
/**
 * 직접 SMS 발송 (테스트용 - Task 없이 바로 발송)
 */
export async function sendSmsDirectly(
  phoneNumber: string,
  message: string
): Promise<boolean>
```

---

### 7. 마스터 플랜 v2.0 업데이트
**파일**: `BIZCONNECT_MASTER_PLAN.md`

- 상세 콜백 발송 흐름도 추가
- 3가지 콜백 옵션 설정 UI 설계
- DB 스키마 설계 (user_settings 컬럼)
- 개발 로드맵 업데이트

---

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `SmsModule.java` | Android 12+/13+ 호환성 수정 |
| `taskService.ts` | try-catch 구문 오류 수정 |
| `babel.config.js` | 새로 생성 |
| `callbackManager.ts` | 3가지 이벤트 타입, handleCallEvent 함수 추가 |
| `callDetectionService.ts` | 이벤트 타입 결정 로직 구현 |
| `smsSender.ts` | sendSmsDirectly 함수 추가 |
| `BIZCONNECT_MASTER_PLAN.md` | v2.0 업데이트 |

---

## 테스트 결과

### Android 15 (Galaxy S22) 테스트
1. Release APK 빌드 성공
2. ADB 설치 성공
3. 앱 실행 - 정상
4. 로그인 - 정상
5. 홈 화면 - 정상 (더 이상 크래시 없음)
6. 통화 종료 후 SMS 발송 - **성공!**

---

## 다음 작업 예정

### Phase 1 (계속)
- [ ] 앱에서 콜백 설정 화면 구현
  - 3가지 옵션 ON/OFF 토글
  - 메시지 템플릿 편집
  - 명함 이미지 업로드
- [ ] MMS 발송 구현 (명함 이미지 첨부)
- [ ] user_settings DB에 설정 저장

### Phase 2
- [ ] 카테고리별 발송 여부 테스트
- [ ] AI 맞춤 문자 API 연동

---

## 기술 노트

### Android API Level 호환성
| 기능 | API Level | Android 버전 |
|------|-----------|-------------|
| PendingIntent FLAG_IMMUTABLE | 31+ | Android 12+ |
| RECEIVER_NOT_EXPORTED | 33+ | Android 13+ |

### 빌드 명령어
```powershell
# Release APK 빌드
powershell.exe -Command "Set-Location 'C:\call\mobile\android'; [Environment]::SetEnvironmentVariable('JAVA_HOME', 'C:\Java\jdk-17.0.13+11', 'Process'); & .\gradlew.bat assembleRelease --no-daemon '-PreactNativeArchitectures=arm64-v8a'"

# APK 설치
& 'C:\AndroidSdk\platform-tools\adb.exe' install -r 'C:\call\mobile\android\app\build\outputs\apk\release\app-release.apk'
```

---

---

## 추가 작업 (오후)

### 8. 3가지 옵션별 개별 이미지 설정
**파일**: `mobile/src/lib/callbackManager.ts`

각 콜백 옵션(통화종료/부재중/통화중)에 개별 이미지를 설정할 수 있도록 구현

#### 이미지 우선순위 로직
```
1. 옵션별 개별 이미지가 있으면 → 그것 사용 (callback_on_xxx_image_url)
2. 개별 이미지 없고 business_card_enabled=true면 → 기본 명함 사용
3. 둘 다 없으면 → 이미지 없이 SMS로 발송
```

---

### 9. MMS 이미지 발송 기능 구현
**파일들**:
- `node_modules/react-native-get-sms-android/android/src/main/java/com/react/SmsModule.java`
- `mobile/android/app/src/main/AndroidManifest.xml`
- `mobile/android/app/src/main/res/xml/file_paths.xml`
- `mobile/src/lib/smsSender.ts`

#### SmsModule.java에 추가된 메서드
```java
@ReactMethod
public void sendMms(String phoneNumber, String message, String imageUrl,
                    final Callback errorCallback, final Callback successCallback)
```

- 이미지 URL에서 이미지 다운로드
- 임시 파일로 저장
- FileProvider를 통해 Uri 생성
- Intent로 메시지 앱 실행

#### AndroidManifest.xml 변경
```xml
<!-- FileProvider for MMS image sharing -->
<provider
  android:name="androidx.core.content.FileProvider"
  android:authorities="${applicationId}.fileprovider"
  android:exported="false"
  android:grantUriPermissions="true">
  <meta-data
    android:name="android.support.FILE_PROVIDER_PATHS"
    android:resource="@xml/file_paths" />
</provider>
```

---

### 10. DB 스키마 업데이트
**파일**: `supabase/update-callback-settings.sql`

```sql
-- 3가지 옵션별 이미지 컬럼 추가
callback_on_end_image_url TEXT DEFAULT NULL
callback_on_missed_image_url TEXT DEFAULT NULL
callback_on_busy_image_url TEXT DEFAULT NULL
```

---

## 수정된 파일 목록 (추가)

| 파일 | 변경 내용 |
|------|----------|
| `SmsModule.java` | sendMms, autoSendMms 메서드 추가 |
| `AndroidManifest.xml` | FileProvider 추가 |
| `file_paths.xml` | 새로 생성 - 파일 경로 설정 |
| `smsSender.ts` | sendMmsDirectly 함수 추가 |
| `callbackManager.ts` | 옵션별 개별 이미지 지원, MMS 발송 호출 |
| `update-callback-settings.sql` | DB 스키마 SQL 생성 |
| `BIZCONNECT_MASTER_PLAN.md` | 이미지 우선순위 로직 추가 |

---

## 남은 작업 (다음 세션)

- [ ] Supabase에서 SQL 실행하여 DB 스키마 업데이트
- [x] 앱에서 콜백 설정 화면 UI 구현
- [ ] 이미지 업로드 기능 구현
- [ ] MMS 발송 실제 테스트 (이미지 URL 설정 후)

---

## 추가 작업 (계속)

### 11. 앱 콜백 설정 화면 UX 개선
**파일**: `mobile/src/screens/CallbackSettingsScreen.tsx`

#### 개선 내용
- **KeyboardAvoidingView** 추가로 키보드 가림 문제 해결
- 3가지 콜백 옵션 (통화종료/부재중/통화중) UI 구현
- 각 옵션별 ON/OFF 토글 + 메시지 입력 필드
- 색상 구분: 통화종료(초록), 부재중(노랑), 통화중(빨강)
- 하단 여백 추가로 키보드 올라올 때 스크롤 가능

#### UI 구조
```
┌─────────────────────────┐
│ 콜백 서비스 활성화 [ON] │
├─────────────────────────┤
│ 통화종료 [ON]           │
│ ┌─────────────────────┐ │
│ │ 메시지 입력 필드    │ │
│ └─────────────────────┘ │
├─────────────────────────┤
│ 부재중 [ON]             │
│ ┌─────────────────────┐ │
│ │ 메시지 입력 필드    │ │
│ └─────────────────────┘ │
├─────────────────────────┤
│ 통화중 [ON]             │
│ ┌─────────────────────┐ │
│ │ 메시지 입력 필드    │ │
│ └─────────────────────┘ │
├─────────────────────────┤
│ 명함 이미지 첨부 [OFF]  │
├─────────────────────────┤
│ [저장] [취소]           │
└─────────────────────────┘
```

---

### 12. 웹 콜백 설정 UI 업데이트
**파일**: `web/src/app/dashboard/settings/page.tsx`

#### 추가 기능
- 3가지 콜백 옵션 상태 관리 (`callbackOptions` state)
- 상황별 콜백 메시지 설정 UI
- 토글 스위치로 각 옵션 ON/OFF
- 색상 구분 배지: 통화종료(초록), 부재중(노랑), 통화중(빨강)
- 기존 신규/기존 고객 템플릿은 "고급" 섹션으로 이동

#### 새로운 상태
```typescript
const [callbackOptions, setCallbackOptions] = useState({
  callback_on_end_enabled: true,
  callback_on_end_message: '...',
  callback_on_missed_enabled: true,
  callback_on_missed_message: '...',
  callback_on_busy_enabled: true,
  callback_on_busy_message: '...',
})
```

---

## 수정된 파일 목록 (추가)

| 파일 | 변경 내용 |
|------|----------|
| `CallbackSettingsScreen.tsx` | 3가지 옵션 UI, KeyboardAvoidingView 추가 |
| `settings/page.tsx` (웹) | 3가지 콜백 옵션 설정 UI 추가 |

---

## 추가 작업 (저녁)

### 13. 웹 설정 저장 오류 수정
**파일**: `web/src/app/dashboard/settings/page.tsx`

#### 문제
- `anniversary_notifications_enabled` 컬럼이 DB에 없어서 저장 실패

#### 해결
- `handleSave` 함수에서 DB에 존재하는 컬럼만 명시적으로 저장하도록 수정
- `onConflict: 'user_id'` 옵션 추가

```typescript
const saveData = {
  user_id: user.id,
  // 기본 설정
  industry_type, limit_mode, throttle_interval, auto_callback_enabled,
  // 콜백 옵션
  callback_on_end_enabled, callback_on_end_message,
  callback_on_missed_enabled, callback_on_missed_message,
  callback_on_busy_enabled, callback_on_busy_message,
  // 명함, 알림
  business_card_enabled, business_card_image_url,
  push_notifications_enabled, birthday_notifications_enabled,
  anniversary_notifications_enabled, task_notifications_enabled,
  notification_time, birthday_reminder_days, anniversary_reminder_days,
}
```

---

### 14. 앱 명함 이미지 업로드 기능 구현
**파일**: `mobile/src/screens/CallbackSettingsScreen.tsx`

#### 추가된 기능
- `react-native-image-picker` 사용하여 갤러리에서 이미지 선택
- Supabase Storage에 이미지 업로드
- 이미지 미리보기 표시
- 이미지 변경/삭제 버튼

#### 핵심 코드
```typescript
const pickAndUploadImage = async () => {
  const result = await launchImageLibrary({
    mediaType: 'photo',
    quality: 0.8,
    maxWidth: 1024,
    maxHeight: 1024,
  });

  // Supabase Storage에 업로드
  const { data, error } = await supabase.storage
    .from('images')
    .upload(filePath, blob, { contentType: 'image/jpeg', upsert: true });

  // Public URL 가져오기
  const { data: urlData } = supabase.storage
    .from('images')
    .getPublicUrl(filePath);
};
```

---

### 15. DB 스키마 SQL 업데이트
**파일**: `supabase/update-callback-settings.sql`

#### 추가된 컬럼
```sql
-- 알림 설정 컬럼
push_notifications_enabled BOOLEAN DEFAULT true
birthday_notifications_enabled BOOLEAN DEFAULT true
anniversary_notifications_enabled BOOLEAN DEFAULT true
task_notifications_enabled BOOLEAN DEFAULT true
notification_time TIME DEFAULT '09:00:00'
birthday_reminder_days INTEGER DEFAULT 1
anniversary_reminder_days INTEGER DEFAULT 1
```

---

## 최종 수정 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `CallbackSettingsScreen.tsx` | 이미지 업로드 기능 추가 |
| `settings/page.tsx` (웹) | handleSave 오류 수정 |
| `update-callback-settings.sql` | 알림 설정 컬럼 추가 |

---

## GitHub 커밋 기록

| 커밋 | 설명 |
|------|------|
| `d14d874` | Add 3 callback options UI for app and web settings |
| `3583309` | Fix settings save error and add image upload to app |

---

## 오늘의 성과 요약

1. **콜백 SMS 발송 기능 완성**
   - Android 15 호환성 문제 해결
   - 3가지 콜백 이벤트 (통화종료/부재중/통화중) 구현

2. **MMS 이미지 발송 준비**
   - FileProvider 설정 완료
   - 이미지 다운로드 및 첨부 로직 구현

3. **설정 화면 UI/UX 개선**
   - 앱: KeyboardAvoidingView로 키보드 가림 해결
   - 앱: 명함 이미지 업로드 기능 추가
   - 웹: 3가지 콜백 옵션 설정 UI 추가

4. **DB 스키마 정리**
   - 콜백 옵션 컬럼 추가
   - 알림 설정 컬럼 추가

---

**작성일**: 2025년 12월 9일
**작성자**: Claude Code
**버전**: 1.5.0
