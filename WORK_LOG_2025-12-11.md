# BizConnect 작업 일지 - 2025-12-14

## 작업 개요
구글 로그인부터 시작하여 대시보드 UI/UX 개선, AI 메시지 생성 기능, 웹-앱 문자 동기화 등 다양한 기능을 개발했으나, 핵심 기능들이 여전히 작동하지 않는 상태입니다.

---

## 완료된 작업 (2025-12-14)

### 1. 구글 OAuth 로그인 수정
- **파일**: `web/src/app/auth/callback/page.tsx`, `web/src/app/page.tsx`
- **내용**: 
  - `useSearchParams()` Suspense 경계 추가
  - OAuth 콜백 처리 로직 개선
  - Supabase 및 Google Cloud Console 설정 가이드 작성
- **상태**: ✅ 완료 (로그인은 성공)

### 2. 대시보드 UI/UX 개선
- **파일**: `web/src/app/dashboard/page.tsx`, `web/src/app/dashboard/layout.tsx`
- **내용**:
  - 대시보드 디자인 현대화
  - 좌측 사이드바 메뉴 추가
  - 설정 버튼을 로그아웃 버튼 옆으로 이동
  - 개인화 배너 추가
- **상태**: ✅ 완료

### 3. AI 메시지 생성 기능 개선
- **파일**: `web/src/app/api/ai/suggest-message/route.ts`, `web/src/components/AIMessageSuggestions.tsx`
- **내용**:
  - 한국 시간대 인식 추가
  - 사용자 이름 강제 사용 로직
  - AI 의도 샘플 편집 기능 추가
  - 고객 정보 기반 톤 조절
- **상태**: ✅ 부분 완료 (이름 인식 문제 여전히 존재)

### 4. 고객 관리 기능 개선
- **파일**: `web/src/app/dashboard/customers/page.tsx`
- **내용**: 빠른 카테고리 할당 기능 추가
- **상태**: ✅ 완료

### 5. Open Graph 이미지 미리보기 구현
- **파일**: `web/src/app/api/preview/[imageId]/route.ts`
- **내용**: 
  - Open Graph 메타 태그 추가
  - 이미지 크기 1920x1080으로 증가
  - CSS로 이미지 하단 텍스트 숨김 시도
- **상태**: ⚠️ 부분 완료 (여전히 "이미지 미리보기" 텍스트 표시됨)

### 6. 앱 문자 발송 기능 수정
- **파일**: `mobile/src/services/taskService.ts`, `mobile/src/lib/smsSender.ts`
- **내용**:
  - 웹→앱 문자 동기화 로직 개선 시도
  - 폴링 간격 1초로 단축
  - RECENT_MINUTES 30분으로 증가
  - 쿼리 조건 단순화
- **상태**: ❌ 실패 (여전히 작동 안함)

### 7. 앱 UI 수정
- **파일**: `mobile/src/screens/SendSMSScreen.tsx`
- **내용**:
  - 메인 화면 뒤로 가기 버튼 제거
  - 명함 사용 버튼 추가 시도
- **상태**: ⚠️ 부분 완료 (명함 버튼은 추가했으나 작동 안함)

### 8. 명함 이미지 업로드 수정
- **파일**: `mobile/src/screens/CallbackSettingsScreen.tsx`
- **내용**: 웹 API 사용하도록 변경 시도
- **상태**: ❌ 실패 (여전히 에러 발생)

---

## 해결되지 않은 문제점 (Critical)

### 1. 웹에서 문자 보내면 앱에서 전혀 작동 안함 ⚠️⚠️⚠️
- **증상**: 웹에서 문자 발송 시 앱이 전혀 감지하지 못함
- **시도한 해결책**:
  - 실시간 구독 로직 개선
  - 폴링 간격 1초로 단축
  - RECENT_MINUTES 30분으로 증가
  - 쿼리 조건 단순화
  - 디버깅 로그 대량 추가
- **결과**: 전혀 개선되지 않음
- **관련 파일**: `mobile/src/services/taskService.ts`
- **우선순위**: 최우선

### 2. 앱에서 명함 첨부 버튼 작동 안함
- **증상**: 이미지 선택 모달에 "명함 사용" 버튼은 보이지만 클릭해도 작동 안함
- **코드 상태**: `handleSelectBusinessCard` 함수는 추가됨
- **문제점**: 
  - `businessCardImageUrl`이 제대로 로드되지 않을 수 있음
  - `loadBusinessCard` 함수가 제대로 호출되지 않을 수 있음
  - Open Graph URL 생성 로직에 문제가 있을 수 있음
- **관련 파일**: `mobile/src/screens/SendSMSScreen.tsx`
- **우선순위**: 높음

### 3. 명함 이미지 업로드 에러
- **증상**: 콜백 설정 화면에서 명함 이미지 변경 시 에러 발생
- **시도한 해결책**:
  - 웹 API `/api/upload-image` 사용하도록 변경
  - FormData 사용
- **결과**: 여전히 에러 발생
- **관련 파일**: `mobile/src/screens/CallbackSettingsScreen.tsx`
- **우선순위**: 높음

### 4. 이미지 미리보기에 "이미지 미리보기" 텍스트 표시
- **증상**: Open Graph 미리보기에서 이미지 하단에 "이미지 미리보기" 텍스트가 표시되어 이미지를 가림
- **시도한 해결책**:
  - CSS로 `::after` 숨김 처리
  - `og:title`을 "📇 내 명함" 또는 빈 값으로 변경 시도
- **결과**: 여전히 텍스트 표시됨
- **문제점**: 
  - `og:title`이 메시지 앱에서 표시되는 것으로 보임
  - HTML body의 텍스트가 아니라 Open Graph 메타 태그의 title이 문제일 수 있음
- **관련 파일**: `web/src/app/api/preview/[imageId]/route.ts`
- **우선순위**: 중간

### 5. AI가 사용자 이름을 제대로 인식하지 못함
- **증상**: AI가 이메일 ID를 이름으로 사용하거나, 이름이 설정되어 있어도 "이름을 입력하라"고 함
- **시도한 해결책**:
  - `full_name` 강제 사용 로직 추가
  - RLS 정책 수정
  - 디버깅 로그 대량 추가
- **결과**: 여전히 문제 발생
- **관련 파일**: `web/src/app/api/ai/suggest-message/route.ts`
- **우선순위**: 중간

---

## 빌드 관련

### 실제 빌드 명령어
```cmd
cd C:\call\mobile\android
.\gradlew clean
.\gradlew assembleRelease
```

또는

```cmd
C:\call\mobile\build-release.cmd
```

### TODOS.md와의 차이점
- **TODOS.md**: `build-release.cmd` 사용 권장
- **실제**: `gradlew clean` 후 `gradlew assembleRelease` 직접 실행도 가능
- **차이**: TODOS.md는 스크립트 사용을 권장하지만, 실제로는 직접 명령어 실행도 문제없음

### 권장 사항
- `build-release.cmd` 스크립트가 JAVA_HOME을 자동 설정하므로 사용 권장
- 하지만 직접 명령어 실행도 문제없음

---

## 코드 수정 내역 요약

### 웹 (Web)
1. `web/src/app/auth/callback/page.tsx` - OAuth 콜백 처리
2. `web/src/app/page.tsx` - 루트 페이지 리다이렉트
3. `web/src/app/dashboard/page.tsx` - 대시보드 UI 개선
4. `web/src/app/dashboard/layout.tsx` - 레이아웃 추가
5. `web/src/app/dashboard/send/page.tsx` - 단건 발송 제거, 다중 이미지 지원
6. `web/src/app/dashboard/settings/page.tsx` - AI 의도 샘플 편집, 전화번호 필드 추가
7. `web/src/app/dashboard/customers/page.tsx` - 빠른 카테고리 할당
8. `web/src/app/api/ai/suggest-message/route.ts` - AI 로직 개선
9. `web/src/app/api/preview/[imageId]/route.ts` - Open Graph 구현

### 앱 (Mobile)
1. `mobile/src/services/taskService.ts` - 웹→앱 동기화 로직 개선 (실패)
2. `mobile/src/lib/smsSender.ts` - 메시지-URL 줄바꿈 조정
3. `mobile/src/screens/SendSMSScreen.tsx` - 뒤로 가기 버튼 제거, 명함 버튼 추가 (작동 안함)
4. `mobile/src/screens/CallbackSettingsScreen.tsx` - 명함 업로드 로직 변경 (에러 발생)
5. `mobile/src/lib/callbackManager.ts` - 콜백 로직 개선

### 데이터베이스
1. `supabase/add-ai-intent-samples.sql` - AI 의도 샘플 컬럼 추가
2. `supabase/add-phone-to-user-settings.sql` - 전화번호 필드 추가

---

## 다음 작업 우선순위

### 최우선 (Critical)
1. **웹→앱 문자 동기화 완전 수정**
   - 실시간 구독이 작동하지 않는 근본 원인 파악 필요
   - Supabase Realtime 설정 확인 필요
   - RLS 정책 재확인 필요

### 높음 (High)
2. **명함 첨부 버튼 작동 확인**
   - `loadBusinessCard` 함수 호출 확인
   - `businessCardImageUrl` 상태 확인
   - `handleSelectBusinessCard` 함수 디버깅

3. **명함 이미지 업로드 에러 해결**
   - 웹 API 호출 시 에러 메시지 확인
   - FormData 생성 로직 확인
   - React Native FormData 호환성 확인

### 중간 (Medium)
4. **이미지 미리보기 텍스트 제거**
   - `og:title`을 빈 값 또는 최소한의 텍스트로 변경
   - 메시지 앱별 Open Graph 파싱 동작 확인

5. **AI 이름 인식 문제 해결**
   - RLS 정책 재확인
   - `user_settings` 조회 로직 재확인

---

## 참고사항

- 모든 수정 사항은 GitHub에 푸시됨
- 빌드는 성공했으나 기능은 작동하지 않음
- 디버깅 로그는 대량으로 추가되어 있으나 근본 원인 파악 실패
- 사용자 피드백: "아무것도 해결된 게 없다"

---

**작성일**: 2025-12-14  
**상태**: 대부분의 기능이 작동하지 않음  
**다음 작업**: 근본 원인 파악 및 완전한 재작업 필요
