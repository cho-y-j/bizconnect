# AI 비서 기능 구현 가이드

## ✅ 구현 완료

### 1. 데이터베이스 스키마
- `conversation_summaries` 테이블 - 요약 메모 저장
- `ai_suggestions_cache` 테이블 - AI 응답 캐싱 (토큰 절약)

### 2. API 엔드포인트
- `/api/ai/suggest-message` - 문자 메시지 추천
- `/api/ai/summarize-conversation` - 대화 내용 요약

### 3. UI 컴포넌트
- `AIMessageSuggestions` - AI 추천 모달
- 문자 보내기 페이지에 AI 버튼 추가

---

## 📋 설정 필요 사항

### 1. 환경 변수 설정

`web/.env.local` 파일에 추가:

```env
# DeepSeek API 키 (서버 사이드 전용)
DEEPSEEK_API_KEY=sk-af010f64eb7d44d0bb82ef6d3ff0d539
```

**중요:** 
- `NEXT_PUBLIC_` 접두사 없이 설정 (서버 사이드에서만 사용)
- Git에 커밋하지 않음 (`.gitignore`에 포함됨)

### 2. 데이터베이스 마이그레이션

Supabase Dashboard > SQL Editor에서 실행:

1. `supabase/add-ai-features.sql` 파일 열기
2. 전체 내용 복사
3. SQL Editor에 붙여넣기
4. "Run" 버튼 클릭

**생성되는 테이블:**
- `conversation_summaries` - 요약 메모
- `ai_suggestions_cache` - AI 캐시

---

## 🎯 사용 방법

### 문자 메시지 추천

1. `/dashboard/send` 페이지 접속
2. 발송 모드 선택:
   - **단건 발송**: 고객명과 전화번호 입력
   - **다중 발송**: 고객 1명 선택
   - **그룹별/태그별**: 선택 후 진행
3. "✨ AI 추천" 버튼 클릭
4. AI가 3가지 버전 생성:
   - 정중한 버전
   - 친근한 버전
   - 간결한 버전
5. 선택:
   - **적용**: 메시지 입력란에 바로 입력
   - **템플릿 저장**: 템플릿으로 저장

### 대화 내용 요약 (고객 상세 페이지)

1. `/dashboard/customers/[id]` 페이지 접속
2. "대화 요약" 버튼 클릭
3. AI가 대화 이력 분석
4. 요약 메모로 저장 (선택)

---

## 💡 토큰 절약 기능

### 1. 캐싱 시스템
- 같은 고객, 같은 의도, 같은 날짜 → 캐시에서 반환
- 캐시 유효기간: 24시간
- 자동 만료 처리

### 2. 요약 재사용
- 최근 7일 이내 요약이 있고
- 새로운 대화가 없으면
- 기존 요약 재사용

---

## 🔧 기술 세부사항

### API 호출 방식
- DeepSeek API 직접 호출 (fetch API 사용)
- OpenAI SDK 불필요
- Base URL: `https://api.deepseek.com`
- 모델: `deepseek-chat`

### 프롬프트 구조
```
시스템 프롬프트: AI 역할 정의
사용자 프롬프트: 
  - 현재 상황 (날짜, 시간, 요일)
  - 고객 정보
  - 최근 대화 이력 (최대 3개)
  - 사용자 의도
```

### 응답 형식
- JSON 형식 강제 (`response_format: { type: 'json_object' }`)
- 파싱 오류 처리
- 폴백 메시지 제공

---

## 🐛 문제 해결

### AI 추천이 안 나와요
1. 환경 변수 확인: `DEEPSEEK_API_KEY` 설정되었는지
2. 데이터베이스 마이그레이션 실행 확인
3. 브라우저 콘솔에서 에러 확인
4. 네트워크 탭에서 API 요청 확인

### 토큰이 너무 많이 사용돼요
- 캐싱이 작동하는지 확인
- 같은 고객에 대해 반복 호출하지 않도록 주의
- 요약 기능은 필요할 때만 사용

### 템플릿 저장이 안 돼요
- 고객명이 있는지 확인 (템플릿 이름 생성용)
- 템플릿 관리 페이지에서 확인
- 브라우저 콘솔에서 에러 확인

---

## 📊 다음 단계

### 추가 개선 사항
1. 고객 상세 페이지에 요약 기능 추가
2. 요약 메모 표시 UI
3. AI 사용 통계 (사용 횟수 추적)
4. 프롬프트 개선 (더 정확한 추천)

---

## ✅ 체크리스트

- [ ] 환경 변수 설정 (`DEEPSEEK_API_KEY`)
- [ ] 데이터베이스 마이그레이션 실행
- [ ] 문자 보내기 페이지에서 AI 버튼 확인
- [ ] AI 추천 테스트
- [ ] 템플릿 저장 테스트
- [ ] 캐싱 작동 확인 (토큰 절약)

